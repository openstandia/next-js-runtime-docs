## まえがき

本ドキュメントでは、DenoやBunといった次世代JSランタイムを使用し、JS/TSの開発体験向上のためのガイドやプラクティスを紹介します。

## 次世代JSランタイムとは？

### JSランタイム

JavaScriptはもともとブラウザ上で実行されることを前提としたプログラミング言語です。しかし、イベントループやノンブロッキングI/OといったJavaScriptが持つ特性をサーバサイドアプリケーションにも活用したいというニーズが高まりました。そのニーズに応え、エンジニアのRyan Dahlが2009年にリリースしたのが、サーバサイドでもJavaScriptを実行できるランタイム（実行環境）であるNode.jsです。

Node.jsがインストールされたサーバでは、Node.jsによってJavaScriptアプリケーションが実行されます。Node.jsは標準ライブラリを提供しており、ファイルやネットワークなどのI/O操作をアプリケーションから利用することができます。

Node.jsは実行環境としてだけでなく、開発環境としても利用されることが増えています。これは、開発に必要なツールやライブラリがパッケージとして公開されているためです。まず、開発環境の構築のために開発端末にNode.jsをインストールし、ビルド成果物を動かすために実行端末にもNode.jsをインストールすることが一般的になっています。

Node.jsはnpmというパッケージマネージャも提供しています。npmを使用することで、JavaScript向けのライブラリやフレームワークを個別にインストールして利用することができます。

### Node.jsが抱える課題

前述のように、Node.jsは開発時・実行時の両方でランタイムとしてのデファクトスタンダードの地位を築いています。しかし、Node.jsが登場してからJavaScriptを取り巻く環境は大きく変わり、その中でNode.jsの課題が顕著になってきました。

Node.jsの作者であるRyan Dahlは、jsconf.eu 2018で「10 Things I Regret About Node.js」というタイトルでNode.jsに対する後悔を語っています。中にはすでに解決されているものもありますが、現行のNode.jsが抱える主な課題は以下の通りです。

- 動的型付けの問題
- ファイルやネットワークに対するパーミッションコントロールが不足していること
- ビルドシステムがgypであること
- package.jsonにノイズが多く、ディレクトリ単位でモジュール化してしまうこと
- モジュール解決システム（`node_modules`）が複雑すぎること
- import時に`.js`のような拡張子を省略できること

### アプローチ

Node.jsの課題を解決し、より良いJS/TSの開発体験を実現するために、Node.jsに代わる次世代JSランタイムが登場しました。

2024年現在、次世代JSランタイムの中で開発が進んでいる主なものに「Deno」と「Bun」があります。

Denoは、前述のNode.jsの開発者であるRyan DahlがNode.jsの後悔を解消するために新たに開発したJSランタイムです（名前もNodeのアナグラムになっています）。

BunはJarred Sumnerが開発したJSランタイムで、Zigという言語で作成されており、非常に高速で動作するのが特徴です。Node.js時代の資産をそのまま活用できることを目指しており、Node.jsプロジェクトのような構成やnpmパッケージとの互換性が強調されています。

どちらのランタイムも、従来のnpmパッケージの活用やバンドラ・トランスパイラの内蔵といった特徴を備えており、開発時の書きやすさと速さを重視しています。

## 次世代JSランタイムの導入

前章で述べたように、現在のJSランタイムの出番は大きく以下の2つあります。

- 開発環境（＋CICD環境）
- 実行環境

開発環境とは、開発者の開発端末にインストールされ、開発時に様々なツールを使用するときにJSランタイムを必要とする環境を指します。
開発端末だけでなく、例えばCICD環境やビルド環境といった、executableなファイルを生成するまでのステップを実行する環境も含めます。

実行環境とは、ビルド成果物のようなexecutableなファイルを実際に動作させる環境を指します。


### 開発プロセス

開発プロセスでは、Node.jsは主に開発ツールの実行に必要になります。
一般的に、JSやTSのプロジェクトはバンドラやトランスパイラを通じたビルドが必要です。それらのツールを実行するための環境として、Node.jsが必要です。

また、Node.jsで動く便利なCLIツールも多く、それらを動かすためにもNode.jsは必要とされています。

ビルド成果物の実行環境とは別であり、実行環境のランタイム向けのビルドができるのであれば、必ずしも実行環境のランタイムと同じランタイムである必要はありません（Node.js向けのプロジェクトをDenoで作成するなど）。

### 実行環境

ビルド成果物を実行するために、実行環境にインストールするケースです。
アプリケーションが要求するAPIを持っている、もしくはそれと互換性があるランタイムである必要があります。

DenoやBunは大部分のNode.js APIをサポートしているため、その範囲内であればNode.jsアプリケーションの実行環境として利用できます。



## Node.jsとDenoとBunの比較

Node.js、Deno、Bunの３つを、いろいろな項目で比較してみます。

| 比較項目 | Node.js | Deno | Bun |
| - | - | - | - |
| TypeScript | コンパイラのインストールが必要 | ネイティブ対応 | ネイティブ対応 |
| 速度 | 低速 | 普通 | 高速 |
| モジュールシステム | npm | 独自 | npmを踏襲 |
| npmパッケージ | 対応 | 対応 | 対応 |
| Node API | 対応 | 一部対応 | 一部対応 |
| `.env`ファイル | `dotenv`が必要 | ネイティブ対応 | ネイティブ対応 |
| テスト | テストフレームワークが必要 | 標準搭載 | 標準搭載 |
| linterやformatter | 追加で必要 | 標準搭載 | 追加で必要 |
| バンドラ | 非搭載 | 標準搭載 | 標準搭載 |

※独自機能などの詳細はそれぞれの記事を参照してください。

DenoとBunのどちらも、単なるランタイムとしての機能だけでなく、テストやバンドラといった周辺ツールも搭載していることが特徴です。
また、既存のnpmパッケージもサポートしており、Node.jsからのマイグレーションの敷居もある程度低いと言えるでしょう。

### Denoが向いているユースケース

Denoは、セキュリティをデフォルトで有効にした設計や、TypeScriptの標準サポート、独自のモジュールシステムを持つことが特徴です。
従来のNode.jsエコシステムから離れ、軽量で安全性の高い環境を求める場合や、依存関係を最小限に抑えた新規プロジェクトに向いています。
また、モジュール管理がURLベースである点や標準でテスト機能、linter、formatterが搭載されている点から、シンプルで最新の開発体験を重視するプロジェクトにも向いています。

### Bunが向いているユースケース

BunのインターフェースはNode.jsの使用感に近しくなっています。
テストツールもJest記法をそのまま使える、パッケージのバージョン管理を`package.json`で行うなどの従来のNode.jsプロジェクトとの共通点も多いため、マイグレーションの難易度を低くしたい場合に向いています。
大きな変更を加えなくても、パッケージインストールの速度向上などの恩恵を受けることができます。